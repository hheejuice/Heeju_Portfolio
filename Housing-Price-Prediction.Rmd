---
title: "Housing Price Prediction"
output: 
  html_document:
    keep_md: true
---

### Introduction

Price of real estate properties are dependent on a number of features of that property such as number of rooms, size of house, and type of property. For example, someone should be ready to pay at least few hundreds more as monthly rent if he or she is looking to find house with an additional room. While there are many drivers that can affect the house price, some of the features will have stronger effect than others, and we can use such strong predictors to predict the house price using predictive models. In this report, I will use several different models to analyze the effect of the features on price of house in Peru and Ecuador. Additionally, given that the economic and political environment of each country are different, the effect of each feature can also vary. For example, the change in rent price of an apartment unit in US due to construction of railway station nearby will not be necessarily the same to another apartment unit with the same situation in Mexico. Therefore, I will also compare two countries using relevant housing price data.

### Methodology

1)	Pre-Processing 
I will first convert the currency into USD to maintain consistency across price data. Also, ‘0’ values from price data will also removed because it is illogical to have $0 price for houses with rooms. There could have been some error while collecting data.
Then, in order to decide which column (feature) to remove or keep, I will use my own judgment looking at the number of values. To figure out features that could help to predict the price, I will first look into the number of unique values, NA values, and blank values in each column. Then I will remove columns which had too many unique values. I will also remove columns with only one unique values, and the columns with large NA and blank values, except for ‘bedroooms’ column since the source of data (Kaggle) specifically mentioned that this column will be useful for all countries other than Argentina. Remaining features besides ‘price’ feature will be l2, bedrooms, bathrooms, surface_total, and property_type, and I decided to use these features as predictors for price.
Next, I split the data into data for rent price and for-sale price, and decided to only analyze for sale price since it had more rows of data. I also scaled the values at the end for normalization.

2)	Train and Test Data
After the preprocessing, I split the for-sale house price datasets into training (80%) and testing (20%) sets. I will then use several models on the train and test data, and calculate the RMSE of each model for easier comparison.

3)	Build model
I will build predictive and interpretable models using various R packages. The code will be included in the Appendix.

4)	Compare two countries
I will compare Peruvian house price and Ecuadorian house price by analyzing models I built.

### Loading Packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
#knitr::opts_chunk$set(echo=T, results='hide')
library(psych)
library(corrplot)
library(dplyr)
library(caret)
library(class)
library(tree)
```

### Data Description

For the purpose of this project, I used Peruvian and Ecuadorian housing price data sourced from Kaggle. Each dataset consists of a lot of information about each real estate listing.

```{r data}
#reading Peruvian housing data
peru = read.csv("pe_properties.csv", header = TRUE, sep = ",", stringsAsFactors = T) 

#reading Ecuadorian dataset
ecuador = read.csv("ec_properties.csv", header = TRUE, sep = ",", stringsAsFactors = T)

#Descriptive statistic of original Peruvian and Ecuadorian data
dim(peru) # the number of rows and columns
dim(ecuador) # the number of rows and columns

names(peru) #column names
names(ecuador) #column names

str(peru) # shows data structure and variable type of each column
str(ecuador) # shows data structure and variable type of each column

summary(peru) # summary statistics
summary(ecuador) # summary statistics
```

The original Peruvian data has 124449 rows and 25 columns. The original Ecuadorian data has 143565 rows and 25 columns. The column names of both data sets are identical. One of the columns is ‘price’, which is the target feature. There are both numeric (continuous) variables and categorical variables in the datasets. The categorical values are stored as factor variables.

Next, we will be looking at the number of misleading values in the dataset.

```{r na}
# function that returns the number of unique values in each column
UniqueValue = function (x) {length(unique(x)) }

# function that returns the number of NA values in each column
NaValue = function (x) {sum(is.na(x)) }

# function that returns the number of blank values in each column
BlankValue = function (x) {sum(x=="") }


# Peruvian data
#remove columns with too many unique values
#remove columns with one unique value
apply(peru, 2, UniqueValue) #check for number of unique values in each column
apply(peru, 2, NaValue) #check for number of NA values in each column
apply(peru, 2, BlankValue) #check for number of blank values in each column

#Ecuadorian data
apply(ecuador, 2, UniqueValue) #check for number of unique values in each column
apply(ecuador, 2, NaValue) #check for number of NA values in each column
apply(ecuador, 2, BlankValue) #check for number of blank values in each column
```

Considering the number of rows for Peruvian data is 124449, the number of unique values, NA values, and missing values in columns – ‘rooms’, ‘surface_covered’, ‘title’, ‘description’, etc. – are very high.
Ecuadorian data set also has high number of such values in most of its columns. This could make the prediction I would perform very misleading. Therefore, I will pre-process the dataset before I further proceed into developing predictive models as discussed at the beginning of this report.

### Pre-processing

```{r preprocessing}
#drop columns not needed (columns with too many unique/NA/blank values or one unique value)
peru[,c("id", "ad_type", "start_date", "end_date", "created_on", "lat", "lon", "l1", "l3", "l4", "l5", "l6", "rooms","surface_covered", "title", "description")] <- list(NULL)
ecuador[,c("id", "ad_type", "start_date", "end_date", "created_on", "lat", "lon", "l3", "l4", "l5", "l6", "rooms","surface_covered", "price_period","title", "description")] <- list(NULL)

#drop rows where price value is 0 or NA
peru<-peru[!(peru$price == 0),]
peru <- peru[!is.na(peru$price),]
ecuador<-ecuador[!(ecuador$price == 0),]
ecuador <- ecuador[!is.na(ecuador$price),]

#convert Peruvian currency and Argentine peso into USD and then remove the original currency column
levels(peru$currency) # blank, Peruvian currency, Argentine peso
peru <- peru[!(peru$price == ""),] # remove blank values
X<-split(peru, peru$currency)
peru$price <- ifelse(peru$currency == "PEN", peru$price * 0.29, peru$price) #convert the price in Peruvian currency into USD
peru$price <- ifelse(peru$currency == "ARS", peru$price * 0.014, peru$price) #convert the price in Argentine peso int USD
peru$currency <- NULL # remove currency column
summary(peru)

#remove rows with blank currency value for Ecuadorian data set
levels(ecuador$currency) # only USD and blank values
ecuador<-ecuador[!(ecuador$price == ""),] # remove blank price value
ecuador$currency <- NULL # remove currency column
summary(ecuador)

levels(peru$price_period) # price_period column of Peruvian data set only has two variables - 'mensual' and blank value
#remove price_period column from Peruvian data since it only has one unique value after removing blank values
X<-split(peru, peru$price_period)
peru$price_period <- NULL # remove the column

levels(ecuador$l1) # has two values - 'Ecuador' and 'Estados Unidos de America'
#remove rows where l1 is Estados Unidos de América from ecuadorian data
#because this dataset is supposed to have Ecuadorian data only
ecuador<-ecuador[!(ecuador$l1 == "Estados Unidos de América"),]
ecuador$l1 <- NULL #we remove l1 since there are only 1 unique value

#remove NA values from 'bedrooms', 'bathrooms', 'surface_total'
peru <- peru[!is.na(peru$bedrooms),]
peru <- peru[!is.na(peru$bathrooms),]
peru <- peru[!is.na(peru$surface_total),]
ecuador <- ecuador[!is.na(ecuador$bedrooms),]
ecuador <- ecuador[!is.na(ecuador$bathrooms),]
ecuador <- ecuador[!is.na(ecuador$surface_total),]

#drop temporary rent data because there are only few values in it
levels(peru$operation_type)
peru<-peru[!(peru$operation_type =="Alquiler temporal"),]

levels(ecuador$operation_type)
ecuador<-ecuador[!(ecuador$operation_type =="Alquiler temporal"),]

apply(peru, 2, UniqueValue) #every column now has more than 1 unique values
apply(ecuador, 2, UniqueValue) #every column now has more than 1 unique values

# remove l2 column for having too many unique values as qualitative variable
peru$l2 <- NULL
ecuador$l2 <- NULL

peru$property_type <- NULL
ecuador$property_type <- NULL

#check for the number of misleading values -  either NA or blank values
#if there are none, we can proceed
apply(peru, 2, NaValue)
apply(peru, 2, BlankValue)
apply(ecuador, 2, NaValue)
apply(ecuador, 2, BlankValue)

head(peru) #show pre-processed Peruvian data
head(ecuador) #show pre-processed Ecuadorian data
```

After pre-processing, there are no more NA and missing values in the data set, and every column has more than 1 unique values. Also, all monetary values are in USD. 

```{r split}
#split rent and for sale data
#I will only analyze for sale price data
X<-split(peru, peru$operation_type)
peru.rent <- X$Alquiler
peru.sale <- X$Venta
peru.sale$operation_type <- NULL

X<-split(ecuador, ecuador$operation_type)
ecuador.rent <- X$Alquiler
ecuador.sale <- X$Venta
ecuador.sale$operation_type <- NULL

#divide the price value by thousand for ease of interpretation later stage
peru.sale$price <- peru.sale$price /1000
ecuador.sale$price <- ecuador.sale$price /1000

#normalize/scale numeric values
peru.sale$price = scale(peru.sale$price)
peru.sale$bedrooms = scale(peru.sale$bedrooms)
peru.sale$bathrooms = scale(peru.sale$bathrooms)
peru.sale$surface_total = scale(peru.sale$surface_total)
ecuador.sale$price = scale(ecuador.sale$price)
ecuador.sale$bedrooms = scale(ecuador.sale$bedrooms)
ecuador.sale$bathrooms = scale(ecuador.sale$bathrooms)
ecuador.sale$surface_total = scale(ecuador.sale$surface_total)

head(peru.sale) #show pre-processed Peruvian sale data
head(ecuador.sale) #show pre-processed Ecuadorian sale data
```

### Analysis

#### Develop a predictive model of the published price:

As discussed earlier, I pre-processed the original dataset to determine which features to include in my predictive model for price. Remaining columns are the target feature, ‘price’, and features that could help to predict the price, which are l2, bedrooms, bathrooms, surface_total, and property_type. Below is the head of both datasets I will be using. Note that l2 and property_type are categorical variables.

```{r predict}
#Peruvian data
#make training (80%) and testing (20%) set using pre-processed for sale data
set.seed(123)
train = sample(1:nrow(peru.sale), 0.8*nrow(peru.sale))
peru.train = peru.sale[train,]
peru.test = peru.sale[-train,]
dim(peru.train)
dim(peru.test)

#Ecuadorian data
#training 80% and testing 20%
set.seed(123)
train = sample(1:nrow(ecuador.sale), 0.8*nrow(ecuador.sale))
ecuador.train = ecuador.sale[train,]
ecuador.test = ecuador.sale[-train,]
dim(ecuador.train)
dim(ecuador.test)
```

After making training and testing set, I decided to use linear regression and k-Nearest Neighbor (KNN) models to predict the price because the dependent variable I am looking at is continuous variable. Some other models such as logistic regression which uses glm() command in R works well when the dependent variable is categorical with 2 categories. SVM and other classification models also works better with binary dependent variable.

1) Linear Regression

1-1) Peru

Below shows the result of linear regression on Peruvian data.

```{r lmperu}
options(scipen = 999)
peru.lm = lm(price ~ .,  data = peru.train)
summary(peru.lm)

#########
#coef(peru.lm)
#a<-coef(peru.lm)["(Intercept)"]
#coef(peru.lm)["bedrooms"]
######

confint(peru.lm) # confidence interval for coefficient estimates

# predicted price value
head(predict(peru.lm, peru.test,interval = "confidence")) #95% confidence interval
head(predict(peru.lm, peru.test, interval = "prediction")) # 95% prediction interval

#function for RMSE calculation
rmse <- function(y, yhat) {
  sqrt(mean((y - yhat)^2))
}

#rmse
sqrt(mean(peru.lm$residuals^2)) 
rmse(peru.train$price, predict(peru.lm))

#plot(price, bedrooms + bathrooms + surface_total)
#abline(peru.lm)

#plot <- ggplot(data=peru.train,aes(x=bedrooms+bathrooms+surface_total,y=price)) + geom_point() +
#  stat_smooth(method = "lm", se = FALSE)
#plot

#plot <- ggplot(data=peru.test,aes(x=bedrooms+bathrooms+surface_total,y=price)) + geom_point() +
#  stat_smooth(method = "lm", se = FALSE)
#plot

# don't include this???
#diagnostic plots
#par(mfrow=c(2,2))
#plot(peru.lm)
```

1-2) Ecuador

Same models and methodologies were used for Ecuadorian dataset. Below shows the result of linear regression model on it.

```{r lmecuador}
options(scipen = 999)
ecuador.lm = lm(price ~ .,  data = ecuador.train)  
summary(ecuador.lm)

confint(peru.lm)

# predicted price value
head(predict(ecuador.lm, ecuador.test,interval = "confidence")) #95% confidence interval
head(predict(ecuador.lm, ecuador.test, interval = "prediction")) # 95% prediction interval

#rmse
sqrt(mean(ecuador.lm$residuals^2)) 
rmse(ecuador.train$price, predict(ecuador.lm)) 

#plot(price, bedrooms + bathrooms + surface_total)
#abline(peru.lm)
```



2) k-Nearest Neighbors (KNN) Model

1-1) Peru

1-2) Ecuador



#### Peru vs Ecuador for housing price drivers

위에 쓴 lm의 coefficient 비교 
위의 peru.lm과 ecuador.lm을 variable에 store해서 불러와서 보여준담에 줄줄 쓰면될듯

#### Interpretable Model


#-----
#### Peru

```{r cars, eval=FALSE}
#Problem.2 - See if the drivers in Peru are different than in Ecuador
#for Peruvian data

#linear regression using two variables that are present in both Peruvian and Ecuadorian dataset
peru.lm2 = lm(price ~ bedrooms + bathrooms,  data = peru.train)  
summary(peru.lm2)

#--------------------------------------------------------------------------------------------------------
#Problem.1 - develop a predictive model of the published price
#for Peruvian data

#knn
#convert categorical variables with more than 2 levels into dummy variables
l2 <- as.data.frame(dummy.code(peru.sale$l2))
property_type <- as.data.frame(dummy.code(peru.sale$property_type))
peru.sale <- cbind(peru.sale,property_type,l2)
peru.sale <- peru.sale %>% select(-c("l2","property_type"))
head(peru.sale)

#remove variables with zero variance
nearZeroVar(peru.sale)
peru.sale <- peru.sale[,-nearZeroVar(peru.sale)]
nearZeroVar(peru.sale)

#re-making train set and test set with new data
set.seed(123)
train = sample(1:nrow(peru.sale), 0.8*nrow(peru.sale))
peru.train = peru.sale[train,]
peru.test = peru.sale[-train,]

#knn
set.seed(123)
model <- train(
  price~., data = peru.train, method = "knn",
  trControl = trainControl("cv", number = 10),
  preProcess = c("center","scale"),
  tuneLength = 10
  )
model
model$bestTune

#predicted values
predictions <- model %>% predict(peru.test)
head(predictions)

#rmse
rmse(predictions, peru.test$price)

#--------------------------------------------------------------------------------------------------------
#Problem.3 - Build an interpretable model for both countries
#for Peruvian data

#decision tree
tree.peru = tree(price ~ . , data = peru.train)
summary(tree.peru)  
tree.peru
plot(tree.peru)
text(tree.peru, pretty = 0)
tree.pred = predict(tree.peru, peru.test)
table(tree.pred, peru.test$price)

#--------------------------------------------------------------------------------------------------------
#Problem.4 - Compare the predicted prices of comparable properties in Peru and Ecuador
#for Peruvian data

#pre-process to find comparable properties
#where Casa=1 (property type is house)
peru.sale<-peru.sale[!(peru.sale$Casa == 0),]
peru.sale$Casa <- NULL
peru.sale$Departamento <- NULL
peru.sale$Otro <- NULL
peru.sale$Lima <- NULL
peru.sale$Arequipa <- NULL

#pre-process to find comparable properties
#house with top 25% number of bedrooms
bedrooms.third.quantile <- quantile(peru.sale$bedrooms,0.75, names = FALSE)
peru.sale<-peru.sale[(peru.sale$bedrooms > bedrooms.third.quantile),]

#re-make train and test data set
set.seed(123)
train = sample(1:nrow(peru.sale), 0.8*nrow(peru.sale))
peru.train = peru.sale[train,]
peru.test = peru.sale[-train,]
dim(peru.train)
dim(peru.test)

#linar regression
peru.lm3 = lm(price ~ .,  data = peru.train) 
summary(peru.lm3)

#mean of predicted values
mean(predict(peru.lm3))

```


#### Ecuador 

```{r dd, eval=FALSE}


#--------------------------------------------------------------------------------------------------------
#Problem.2 - See if the drivers in Peru are different than in Ecuador
#for Ecuadorian data

#linear regression using two variables that are present in both Peruvian and Ecuadorian dataset
ecuador.lm2 = lm(price ~ bedrooms + bathrooms,  data = ecuador.train)  
summary(ecuador.lm2)

#--------------------------------------------------------------------------------------------------------
#Problem.1 - develop a predictive model of the published price
#for Ecuadorian data

#knn
#convert categorical variables with more than 2 levels into dummy variables
l2 <- as.data.frame(dummy.code(ecuador.sale$l2))
property_type <- as.data.frame(dummy.code(ecuador.sale$property_type))
ecuador.sale <- cbind(ecuador.sale,property_type,l2)
ecuador.sale <- ecuador.sale %>% select(-c("l2","property_type"))
head(ecuador.sale)

#removing variables with zero variance
nearZeroVar(ecuador.sale)
ecuador.sale <- ecuador.sale[,-nearZeroVar(ecuador.sale)]
nearZeroVar(ecuador.sale)

#re-making train set and test set with new data
set.seed(123)
train = sample(1:nrow(ecuador.sale), 0.8*nrow(ecuador.sale))
ecuador.train = ecuador.sale[train,]
ecuador.test = ecuador.sale[-train,]

#knn
set.seed(123)
model <- train(
  price~., data = ecuador.train, method = "knn",
  trControl = trainControl("cv", number = 10),
  preProcess = c("center","scale"),
  tuneLength = 10
  )
model$bestTune
predictions <- model %>% predict(ecuador.test)

#predicted values
head(predictions)

#rmse
rmse(predictions, ecuador.test$price) 

#--------------------------------------------------------------------------------------------------------
#Problem.3 - Build an interpretable model for both countries
#for Ecuadorian data

#decision tree
tree.ecuador = tree(price ~ . , data = ecuador.train)
summary(tree.ecuador)  
tree.ecuador
plot(tree.ecuador)
text(tree.ecuador, pretty = 0)
tree.pred = predict(tree.ecuador, ecuador.test)
table(tree.pred, ecuador.test$price)

#--------------------------------------------------------------------------------------------------------
#Problem.4 - Compare the predicted prices of comparable properties in Peru and Ecuador
#for Ecuadorian data

#pre-process to find comparable properties
#where Casa=1 (property type is house)
ecuador.sale<-ecuador.sale[!(ecuador.sale$Casa == 0),]
ecuador.sale$Casa <- NULL
ecuador.sale$Departamento <- NULL
ecuador.sale$Otro <- NULL
ecuador.sale$Pichincha <- NULL
ecuador.sale$Guayas <- NULL
ecuador.sale$Azuay <- NULL
ecuador.sale$Manabi <- NULL

#pre-process to find comparable properties
#house with top 25% number of bedrooms
bedrooms.third.quantile <- quantile(ecuador.sale$bedrooms,0.75, names = FALSE)
ecuador.sale<-ecuador.sale[(ecuador.sale$bedrooms > bedrooms.third.quantile),]

#re-make train and test data set
set.seed(123)
train = sample(1:nrow(ecuador.sale), 0.8*nrow(ecuador.sale))
ecuador.train = ecuador.sale[train,]
ecuador.test = ecuador.sale[-train,]
dim(ecuador.train)
dim(ecuador.test)

#linear regression
ecuador.lm3 = lm(price ~ .,  data = ecuador.train)
summary(ecuador.lm3)

#mean of predicted values
mean(predict(ecuador.lm3))
```
