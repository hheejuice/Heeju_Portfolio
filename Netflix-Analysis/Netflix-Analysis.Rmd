---
title: "Netflix Analysis"
output: 
  html_document:
    keep_md: true
---
### Loading Packages

```{r setup, include=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
#load required packages
library(tidyverse)
library(dplyr)
library(ggplot2)
library(plotly)
library(rworldmap)
```

### Basic Data Information

```{r data}
df <- read.csv("netflix_titles.csv", stringsAsFactors = F) # read data

summary(df) # summary statistics
length(df$release_year) # number of observations
length(unique(df[,"director"])) # number of unique values - it has duplicates

sapply(df, function(x) sum(is.na(x) | x == 0 | x == "")) # number of NA, 0, and blank values
sapply(df, function(x) sum(is.na(x))) # no NA
sapply(df, function(x) sum(x == 0)) # no 0 values
sapply(df, function(x) sum(x == "")) # every null values are blank values
```

### Visualization

#### Netflix trends by year

```{r year, include=T}
# To investigate yearly trends, I need to eliminate Month and Day data from 'date_added' column
head(df$date_added,5) # this column is originally in 'Month Day, Year' format
class(df$date_added) # column class: character

df$date_added <- sub(".*(\\d+{4}).*$", "\\1", df$date_added) # convert date to year
head(df$date_added,5) # this column now only has year data

# total number of movies and TV shows added to Netflix by year
year <- df %>%
  filter(!(date_added == "")) %>% # remove missing values
  group_by(date_added) %>%
  summarise(count = n()) # number of movies and TV shows by year added to Netflix
year

# draw a bar plot for number of contents added to Netflix by year
bar <- ggplot(year, aes(x = date_added, y = count, fill = date_added)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.3) +
  labs(x = "Year", fill = "Year", title = "Number of Contents added to Netflix by Year")
bar

# Netflix trends - movie vs TV shows
group <- df %>%
  filter(!(date_added == "")) %>%
  group_by(type, date_added) %>% # group by content type and year added
  summarise(count = n())
group

# create bar plot for number of contents added by year by content type
bar <- ggplot(group, aes(x = date_added, y = count, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Netflix Trends by Year", x = "Year", "Type")
bar
```

After years of adding more contents each year, Netflix finally added less number of contents to its platform in 2020. Number of movies added to Netflix has dropped in 2020, whereas number of TV shows added has continued to increase.

#### Movie vs TV show

```{r type, include=T}
# create data frame for number of contents by type
type <- df %>%
  group_by(type) %>%
  summarise(count = n())
type

#all plots created afterwards will have title at center
#theme_update(plot.title = element_text(hjust = 0.5)) 

# create bar plot for Netflix contents by type
bar <- ggplot(type, aes(x = type, y = count, fill = type)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count), vjust = -0.3) +
  labs(title = "Netflix contents by type", x = "Type", fill = "Type") + # add title
  theme(plot.title = element_text(hjust = 0.5)) # center title
bar

# create data frames each for movies and TV shows for further analysis
movie <- df[(df$type == "Movie"),]
tv <- df[(df$type == "TV Show"),]
```
Number of movies on Netflix is more than double the number of TV shows.


#### Netflix Movie Analysis

#### Top 10 Countries by number of movies on Netflix

1) Bar plot
```{r country, include=T}
# basic information about movies on Netflix
length(unique(movie$country)) # country column has many duplicates
head(movie$country, 50) # some movies has listed multiple countries separated by comma

# split comma separated country names
country <- unlist(strsplit(movie$country, ", ")) # spliy country names at comma
unique(country) # some country names has comma at the end

# remove leftover commas from country names
country <- gsub(",","", country)
unique(country)

# store the list as data frame
movie_country <- data.frame(country = country)
unique(movie_country$country) # it now has clean country names

# count country names appearing in the original dataset
movie_country <- movie_country %>%
  group_by(country) %>%
  summarise(count = n())
head(movie_country,10)

# top 10 countries by number of movies added to Netflix
bar <- movie_country %>%
  arrange(desc(count)) %>% # most to least
  slice(1:10) %>% # top 10 countries
  ggplot(., aes(x=reorder(country,-count), y = count)) + # bar plot most to least
  geom_bar(stat='identity') + 
  theme_classic() +
  labs(x = "Country", title = "Top 10 Countries by number of movies on Netflix") +
  geom_text(aes(label = count), vjust = -0.3) # add count labels
bar
```

United States has the most number of movies on Netflix.

2) World Map
```{r map, include, results='hide'}
spdf <- joinCountryData2Map(movie_country, joinCode="NAME", nameJoinColumn="country")
mapParams <- mapCountryData(spdf,
               nameColumnToPlot="count",
               catMethod=c(0,1,3,5,10,50,100,300,500,1000,2500),
               mapTitle = "Number of Movies added to Netflix",
               addLegend = FALSE)
do.call(addMapLegend, c(mapParams, legendLabels="all", legendWidth=0.5))

#labelCountries()
```

Continent-wise, Americas - North and South America - exhibits high number of Netflix movies overall.

#### Number of movies by Year
year 지날때마다 각 나라의 영화 개수
line graph - x = year, y = count, fill = country

```{r countbyyear}
genre_country <- movie %>% 
  mutate(listed_in = strsplit(as.character(listed_in), ", ")) %>% # separate genre by commas
  unnest(listed_in) %>%
  mutate(country = strsplit(as.character(country), ", ")) %>% # separate country name by commas
  unnest(country) %>%
  select("title","country","date_added","listed_in")
genre_country

unique(genre_country$country) # some country names still have commas
length(unique(genre_country$country)) # number of unique country names
unique(genre_country$listed_in) # clean; no leftover commas to be deleted

genre_country <- genre_country %>%
  mutate(country = gsub(",","",country)) # remove commas by replacing them with space
genre_country

unique(genre_country$country) # commas removed from country names
length(unique(genre_country$country))

movie_year <- genre_country %>%
#  mutate(date_added = as.numeric(date_added)) %>%
  filter(country == "United States" |
           country == "India"| 
           country == "United Kingdom"| 
           country == "Canada"| 
           country == "France") %>%
  group_by(country, date_added) %>%
  summarise(count = n())
movie_year

#bar <- ggplot(genre_5_country, aes(fill=listed_in, y=count, x=country)) + 
#    geom_bar(position="fill", stat="identity")
#bar

chart <- ggplot(movie_year, aes(x = date_added, y = count, group = country, color = country)) +
  geom_line() +
  labs(x = "Year", y = "Count", fill = "Country", title = "Number of movies by Year in Top 5 Countries")
chart <- ggplotly(chart)
chart
```


#### Netflix movie genre trends by year
 장르 ('listed in' column) 별로 몇년도에 넷플에 애드 됐는지? (release year아니고 넷플 애드된 해)
 몇년도에 어떤 장르가 제일 많이 애드됐는지

```{r genrebyyear, include=T}
head(movie$listed_in,10) # each movie has multiple genres separated by commas

movie_genre <- movie %>% 
  mutate(listed_in = strsplit(as.character(listed_in), ", ")) %>% # split genre column by comma
  unnest(listed_in) %>%
  select("title","date_added","listed_in")
movie_genre

unique(movie_genre$listed_in) # all Netflix genre

movie_genre <- movie_genre %>%
  group_by(date_added, listed_in) %>%
  summarise(count = n()) # count number of genres by year
movie_genre

# stacked bar chart
bar <- ggplot(movie_genre, aes(fill=listed_in, y=count, x=date_added)) + 
  geom_bar(position="stack", stat="identity") +
  labs (x = "Year", fill = "Genre", title = "Genre by Year")
bar <- ggplotly(bar)
bar # interactive로 해서 한 장르의 시간별 변화도 관찰 가능

# percent stacked bar chart
bar <- ggplot(movie_genre, aes(fill=listed_in, y=count, x=date_added)) + 
  geom_bar(position="fill", stat="identity") +
  labs (x = "Year", y = "Percent", fill = "Genre", title = "Genre by Year")
bar
```

마지막 percent stacked barchart를 보면 해가 지날수록 장르가 더 다양해 지는 걸 볼 수 있었음
2014년을 기점으로 international과 LGBTQ movie의 비중이 대폭 늘어남
전체적으로 시간이 지날 수록 영화의 다양성에 집중하고자 하는 양상이 드러남

#### Netflix genre trends by country
```{r genrebycountry, include = TRUE}


#넷플 영화 갯수 탑 5 나라의 장르 비율
#genre_5_country <- genre_country %>%
#  filter(country == "United States" |
#           country == "India"| 
#           country == "United Kingdom"| 
#           country == "Canada"| 
#           country == "France") %>%
#  group_by(country, listed_in) %>%
#  summarise(count = n())

#  stacked bar chart
#bar <- ggplot(genre_5_country, aes(fill=listed_in, y=count, x=country)) + 
#    geom_bar(position="fill", stat="identity")
#bar

# 각 나라 별 도넛 차트 for genre
# https://homepage.divms.uiowa.edu/~luke/classes/STAT4580/catone.html
#pie <- ggplot(genre_5_country) +
#  geom_col(aes(x = 1, y = count, fill = listed_in), position = "fill") +
#  coord_polar(theta = "y") +
#  labs(title = "Movie Genres", fill = "Genre") +
#  facet_wrap(~ country) +
#  theme_bw() +
#  theme(axis.title = element_blank(), # remove axis and grid lines
#        axis.text = element_blank(),
#        axis.ticks = element_blank(),
#        panel.grid.major = element_blank(),
#        panel.grid.minor = element_blank(),
#        panel.border = element_blank())

#pie <- pie + xlim(0, 1.5)
#pie

# 영화 갯수 제일 많은 미국 한 나라의 장르 비율 도넛 차트
genre_usa <- genre_country %>%
  filter(country == "United States") %>%
  group_by(country, listed_in) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

# donut chart 만들기 (많은순으로 정렬)
pie <- ggplot(genre_usa) +
  geom_col(aes(x = 1, y = count, fill = reorder(listed_in,count)), position = "fill") +
  coord_polar(theta = "y", start = 0) +
  labs(title = "Movie Genres in United States", fill = "Genre") +
  guides(fill = guide_legend(reverse = TRUE)) +
  facet_wrap(~ country) +
  theme_bw() +
  theme(axis.title = element_blank(), # remove axis and grid lines
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank())

pie <- pie + xlim(0, 1.5)
pie

```

Very small portion of American movies are categorized as international movies. <- dㅣ건 미국 도넛차트만 둘거면 빼야할듯


